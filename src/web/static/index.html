<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Icarus Trading System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        h1 {
            color: white;
            font-size: 2em;
        }

        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .connected {
            background: #10b981;
        }

        .disconnected {
            background: #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #2a2f4a;
        }

        th {
            color: #a0aec0;
            font-weight: 600;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-buy {
            background: #10b981;
            color: white;
        }

        .badge-sell {
            background: #ef4444;
            color: white;
        }

        #recent-events {
            max-height: 300px;
            overflow-y: auto;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #0f1729;
            border-left: 3px solid #667eea;
            border-radius: 5px;
        }

        .event-time {
            color: #6b7280;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Icarus Trading System Dashboard</h1>
        <div class="connection-status disconnected" id="connection-status">
            Disconnected
        </div>
    </div>

    <div class="grid">
        <!-- Portfolio Summary -->
        <div class="card">
            <h2>Portfolio Summary</h2>
            <table id="portfolio-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Value</th>
                        <th>P&L</th>
                        <th>Alloc%</th>
                    </tr>
                </thead>
                <tbody id="portfolio-body">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Active Positions -->
        <div class="card">
            <h2>Active Positions</h2>
            <table id="positions-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Qty</th>
                        <th>Entry</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="positions-body">
                    <tr><td colspan="4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Recent Trades -->
        <div class="card">
            <h2>Recent Trades</h2>
            <table id="trades-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th>Qty</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody id="trades-body">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Active Forks -->
        <div class="card">
            <h2>Active Database Forks</h2>
            <div id="forks-list">Loading...</div>
        </div>

        <!-- Real-time Events -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>Real-Time Events</h2>
            <div id="recent-events"></div>
        </div>
    </div>

    <script>
        let ws = null;
        const events = [];

        // Connect WebSocket
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8000/ws');

            ws.onopen = () => {
                document.getElementById('connection-status').className = 'connection-status connected';
                document.getElementById('connection-status').textContent = 'Connected';
            };

            ws.onclose = () => {
                document.getElementById('connection-status').className = 'connection-status disconnected';
                document.getElementById('connection-status').textContent = 'Disconnected';
                setTimeout(connectWebSocket, 5000);  // Reconnect after 5s
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleEvent(data);
            };
        }

        // Handle real-time events
        function handleEvent(event) {
            events.unshift(event);
            if (events.length > 50) events.pop();

            const eventsDiv = document.getElementById('recent-events');
            eventsDiv.innerHTML = events.map(e => `
                <div class="event-item">
                    <div class="event-time">${new Date(e.timestamp).toLocaleTimeString()}</div>
                    <div><strong>${e.type}</strong>: ${JSON.stringify(e.data).substring(0, 100)}</div>
                </div>
            `).join('');

            // Refresh data on important events
            if (['trade', 'allocation'].includes(event.type)) {
                loadPortfolio();
                loadTrades();
            }
        }

        // Load portfolio data
        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();

                const tbody = document.getElementById('portfolio-body');
                if (data.strategies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No strategies active</td></tr>';
                } else {
                    tbody.innerHTML = data.strategies.map(s => `
                        <tr>
                            <td>${s.strategy_name}</td>
                            <td>$${s.portfolio_value.toFixed(2)}</td>
                            <td class="${s.total_pnl >= 0 ? 'positive' : 'negative'}">
                                ${s.total_pnl >= 0 ? '+' : ''}$${s.total_pnl.toFixed(2)}
                            </td>
                            <td>${s.allocation_pct.toFixed(1)}%</td>
                        </tr>
                    `).join('');
                }

                const positionsBody = document.getElementById('positions-body');
                if (data.positions.length === 0) {
                    positionsBody.innerHTML = '<tr><td colspan="4">No open positions</td></tr>';
                } else {
                    positionsBody.innerHTML = data.positions.map(p => `
                        <tr>
                            <td>${p.symbol}</td>
                            <td>${p.quantity}</td>
                            <td>$${p.avg_entry_price.toFixed(2)}</td>
                            <td class="${p.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                                ${p.unrealized_pnl >= 0 ? '+' : ''}$${p.unrealized_pnl.toFixed(2)}
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading portfolio:', error);
            }
        }

        // Load recent trades
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades/recent?limit=10');
                const data = await response.json();

                const tbody = document.getElementById('trades-body');
                if (data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No trades yet</td></tr>';
                } else {
                    tbody.innerHTML = data.trades.map(t => `
                        <tr>
                            <td>${new Date(t.time).toLocaleTimeString()}</td>
                            <td>${t.symbol}</td>
                            <td><span class="badge badge-${t.side}">${t.side.toUpperCase()}</span></td>
                            <td>${t.quantity}</td>
                            <td>$${t.price.toFixed(2)}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        // Load active forks
        async function loadForks() {
            try {
                const response = await fetch('/api/forks/active');
                const data = await response.json();

                const div = document.getElementById('forks-list');
                if (data.forks.length === 0) {
                    div.innerHTML = '<p>No active forks</p>';
                } else {
                    div.innerHTML = data.forks.map(f => `
                        <div class="event-item">
                            <strong>${f.fork_id}</strong> - ${f.purpose}
                            <div class="event-time">Requested by ${f.requesting_agent}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading forks:', error);
            }
        }

        // Initialize
        connectWebSocket();
        loadPortfolio();
        loadTrades();
        loadForks();

        // Refresh data periodically
        setInterval(loadPortfolio, 10000);  // Every 10s
        setInterval(loadTrades, 15000);     // Every 15s
        setInterval(loadForks, 30000);      // Every 30s
    </script>
</body>
</html>
